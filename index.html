<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>S&P 500 Divergence Hunter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; color: #222; margin: 0; padding: 0;}
    .container { max-width: 700px; margin: 30px auto; background: #fff; padding: 32px 28px 22px 28px; border-radius: 12px; box-shadow: 0 3px 20px #0001;}
    h1 { margin-top: 0; }
    .explain { color: #555; margin-bottom: 26px;}
    .section { margin-bottom: 38px;}
    .mispricing-list { padding: 0; margin: 0; list-style: none;}
    .mispricing { background: #ffe; border: 1px solid #fd6; padding: 16px; border-radius: 8px; margin-bottom: 18px; }
    .mispricing .symbol { font-weight: bold; font-size: 1.08em; }
    .mispricing .reason { color: #335; }
    .mispricing .news { color: #444; margin-top: 9px; margin-bottom: 3px;}
    #archive { background: #f3f6fa; border-radius: 8px; padding: 15px;}
    #archive select { margin-bottom: 12px;}
    .toggle { margin-bottom: 14px;}
    button, input[type="button"] { cursor: pointer; font-size: 1em; padding: 5px 13px; border-radius: 5px; border: 1px solid #bbb;}
    .archived-label { font-size: 0.96em; color: #555;}
    @media (max-width: 500px) {
      .container { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>S&P 500 Divergence Hunter</h1>
    <div class="explain">
      Finds large moves in S&P 500 stocks that diverge from SPY, surfaces cases where the price action can't be explained by news or where the news is not fundamentally relevant. Updates every 30 minutes. All data shown is public and for educational purposes only.
    </div>

    <div class="section" id="likelySection">
      <h2>Likely Mispricings</h2>
      <ul class="mispricing-list" id="likelyList"></ul>
      <div id="noLikely" style="display:none; color:#888;">No likely mispricings found.</div>
    </div>

    <div class="section" id="possibleSection">
      <div class="toggle">
        <input type="checkbox" id="togglePossible">
        <label for="togglePossible">Show Possible Mispricings</label>
      </div>
      <div id="possibleMispricings" style="display:none;">
        <h3>Possible Mispricings</h3>
        <ul class="mispricing-list" id="possibleList"></ul>
        <div id="noPossible" style="display:none; color:#888;">No possible mispricings found.</div>
      </div>
    </div>

    <div class="section" id="archiveSection">
      <div><b>Archive</b> <span class="archived-label">(cached locally)</span></div>
      <select id="archiveDropdown"></select>
      <input type="button" value="Delete" id="deleteArchive" title="Delete this archive entry">
      <div id="archiveResults" style="margin-top:10px;"></div>
    </div>
  </div>
  <script>
    // === CONFIG ===
    const API_URL = 'https://nkmiuk4v42.execute-api.us-east-1.amazonaws.com/prod/news'; // <-- PUT your API endpoint here!

    // === UTILS ===
    function fmtTime(d) {
      return d.toLocaleString(undefined, {hour:'2-digit',minute:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'});
    }
    function roundToNearestHalfHour(d) {
      let minutes = d.getMinutes();
      if (minutes < 30) d.setMinutes(0,0,0);
      else d.setMinutes(30,0,0);
      return d;
    }
    function getNowKey() {
      let d = new Date();
      return roundToNearestHalfHour(new Date(d)).toISOString();
    }
    function archiveKey(ts) {
      return 'sp500_mispricings_' + ts;
    }
    function saveArchive(ts, result) {
      localStorage.setItem(archiveKey(ts), JSON.stringify(result));
      updateArchiveDropdown();
    }
    function loadArchive(ts) {
      const raw = localStorage.getItem(archiveKey(ts));
      return raw ? JSON.parse(raw) : null;
    }
    function getAllArchiveTimestamps() {
      return Object.keys(localStorage).filter(k=>k.startsWith('sp500_mispricings_')).map(k=>k.slice('sp500_mispricings_'.length));
    }
    function updateArchiveDropdown() {
      let sel = document.getElementById('archiveDropdown');
      let old = sel.value;
      sel.innerHTML = '';
      let timestamps = getAllArchiveTimestamps().sort().reverse();
      timestamps.forEach(ts=>{
        let d = new Date(ts);
        let opt = document.createElement('option');
        opt.value = ts;
        opt.textContent = fmtTime(d);
        sel.appendChild(opt);
      });
      if (old && timestamps.includes(old)) sel.value = old;
      else if (timestamps.length) sel.value = timestamps[0];
      showArchive();
    }

    // === RENDERING ===
    function renderMispricings(list, elem, type) {
      elem.innerHTML = '';
      list.forEach(m=>{
        let li = document.createElement('li');
        li.className = 'mispricing';
        li.innerHTML = `<div class="symbol">${m.symbol} <span style="color:${m.change < 0 ? '#b11' : '#1a4'}">${m.change.toFixed(2)}%</span></div>
          <div class="reason">${m.reason||''}</div>
          ${m.news ? `<div class="news"><b>News:</b><br>${m.news.replace(/\n/g,'<br>')}</div>` : ''}
          `;
        elem.appendChild(li);
      });
    }
    function showArchive() {
      let sel = document.getElementById('archiveDropdown');
      let val = sel.value;
      let result = val ? loadArchive(val) : null;
      let archiveDiv = document.getElementById('archiveResults');
      if (!result) { archiveDiv.innerHTML = '<em>No results archived.</em>'; return; }
      let html = '';
      html += `<h4>Likely Mispricings</h4>`;
      if (result.likelyMispricings?.length)
        html += '<ul class="mispricing-list">' + result.likelyMispricings.map(m=>
          `<li class="mispricing"><div class="symbol">${m.symbol} <span style="color:${m.change<0?'#b11':'#1a4'}">${m.change.toFixed(2)}%</span></div><div class="reason">${m.reason||''}</div>${m.news?`<div class="news"><b>News:</b><br>${m.news.replace(/\n/g,'<br>')}</div>`:''}</li>`
        ).join('') + '</ul>';
      else
        html += `<div style="color:#888;">None</div>`;
      html += `<h4>Possible Mispricings</h4>`;
      if (result.possibleMispricings?.length)
        html += '<ul class="mispricing-list">' + result.possibleMispricings.map(m=>
          `<li class="mispricing"><div class="symbol">${m.symbol} <span style="color:${m.change<0?'#b11':'#1a4'}">${m.change.toFixed(2)}%</span></div><div class="reason">${m.reason||''}</div></li>`
        ).join('') + '</ul>';
      else
        html += `<div style="color:#888;">None</div>`;
      archiveDiv.innerHTML = html;
    }

    // === MAIN LOAD ===
    function showResults(result) {
      const likelyList = document.getElementById('likelyList');
      const possibleList = document.getElementById('possibleList');
      renderMispricings(result.likelyMispricings, likelyList, 'likely');
      renderMispricings(result.possibleMispricings, possibleList, 'possible');
      document.getElementById('noLikely').style.display = result.likelyMispricings.length ? 'none' : '';
      document.getElementById('noPossible').style.display = result.possibleMispricings.length ? 'none' : '';
    }
    function fetchAndRender(force=false) {
      const now = roundToNearestHalfHour(new Date());
      const nowKey = now.toISOString();
      // use cached if available, unless force
      let cached = loadArchive(nowKey);
      if (cached && !force) {
        showResults(cached);
        updateArchiveDropdown();
        return;
      }
      fetch(API_URL)
        .then(r=>r.json())
        .then(result=>{
          showResults(result);
          saveArchive(nowKey, result);
        })
        .catch(err=>{
          alert("Error fetching results. Check your connection.");
        });
    }

    // === SCHEDULING ===
    function msToNextHalfHour() {
      let now = new Date();
      let mins = now.getMinutes();
      let next = new Date(now);
      if (mins < 30) next.setMinutes(30, 0, 0);
      else { next.setHours(next.getHours() + 1); next.setMinutes(0, 0, 0);}
      return next - now;
    }
    function scheduleNextFetch() {
      setTimeout(()=>{
        fetchAndRender(true);
        scheduleNextFetch();
      }, msToNextHalfHour());
    }

    // === EVENT HOOKS ===
    document.getElementById('togglePossible').addEventListener('change', function() {
      document.getElementById('possibleMispricings').style.display = this.checked ? '' : 'none';
    });
    document.getElementById('archiveDropdown').addEventListener('change', showArchive);
    document.getElementById('deleteArchive').addEventListener('click', function() {
      let sel = document.getElementById('archiveDropdown');
      let val = sel.value;
      if (val && confirm("Delete this archive entry?")) {
        localStorage.removeItem(archiveKey(val));
        updateArchiveDropdown();
      }
    });

    // === INIT ===
    window.onload = function() {
      fetchAndRender();
      scheduleNextFetch();
      updateArchiveDropdown();
    };
  </script>
</body>
</html>
