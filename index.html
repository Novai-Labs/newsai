<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>S&P 500 Divergence Hunter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>S&P 500 Divergence Hunter</h1>
    <div class="explain">
      Finds large moves in S&P 500 stocks that diverge from SPY, surfaces cases where the price action can't be explained by news or where the news is not fundamentally relevant. Updates every 30 minutes.<br>
      <b>All data is public and for educational purposes only.</b>
    </div>

    <div class="section" id="likelySection">
      <h2>Likely Mispricings</h2>
      <ul class="mispricing-list" id="likelyList"></ul>
      <div id="noLikely" style="display:none; color:#888;">No likely mispricings found.</div>
    </div>

    <div class="section" id="possibleSection">
      <div class="toggle">
        <input type="checkbox" id="togglePossible">
        <label for="togglePossible">Show Possible Mispricings</label>
      </div>
      <div id="possibleMispricings" style="display:none;">
        <h3>Possible Mispricings</h3>
        <ul class="mispricing-list" id="possibleList"></ul>
        <div id="noPossible" style="display:none; color:#888;">No possible mispricings found.</div>
      </div>
    </div>

    <div class="section" id="archiveSection">
      <div><b>Archive</b> <span class="archived-label">(cached locally)</span></div>
      <div style="display:flex;align-items:center;gap:15px;">
        <select id="archiveDropdown" class="styled-select"></select>
        <input type="button" value="Delete" id="deleteArchive" title="Delete this archive entry">
      </div>
      <div id="archiveResults" style="margin-top:18px;"></div>
    </div>


    <div class="section center">
      <button id="manualPullBtn" class="primary-btn">Pull Latest <span id="cooldown"></span></button>
    </div>
  </div>
  <script>
    // === CONFIG ===
    const API_URL = 'https://nkmiuk4v42.execute-api.us-east-1.amazonaws.com/prod/news'; // <-- YOUR API endpoint
    const MANUAL_PULL_COOLDOWN = 180; // seconds

    // === UTILS ===
    function fmtTime(d) {
      return d.toLocaleString(undefined, {hour:'2-digit',minute:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'});
    }
    function roundToNearestHalfHour(d) {
      let minutes = d.getMinutes();
      if (minutes < 30) d.setMinutes(0,0,0);
      else d.setMinutes(30,0,0);
      return d;
    }
    function archiveKey(ts) {
      return 'sp500_mispricings_' + ts;
    }
    function saveArchive(ts, result) {
      localStorage.setItem(archiveKey(ts), JSON.stringify(result));
      updateArchiveDropdown();
    }
    function loadArchive(ts) {
      const raw = localStorage.getItem(archiveKey(ts));
      return raw ? JSON.parse(raw) : null;
    }
    function getAllArchiveTimestamps() {
      return Object.keys(localStorage).filter(k=>k.startsWith('sp500_mispricings_')).map(k=>k.slice('sp500_mispricings_'.length));
    }
    function updateArchiveDropdown() {
      let sel = document.getElementById('archiveDropdown');
      let old = sel.value;
      sel.innerHTML = '';
      let timestamps = getAllArchiveTimestamps().sort().reverse();
      timestamps.forEach(ts=>{
        let d = new Date(ts);
        let opt = document.createElement('option');
        opt.value = ts;
        opt.textContent = fmtTime(d);
        sel.appendChild(opt);
      });
      if (old && timestamps.includes(old)) sel.value = old;
      else if (timestamps.length) sel.value = timestamps[0];
      showArchive();
    }

    // === RENDERING ===
    function renderMispricings(list, elem, type) {
      elem.innerHTML = '';
      list.forEach(m=>{
        let li = document.createElement('li');
        li.className = 'mispricing';
        li.innerHTML = `<div class="symbol">${m.symbol} <span style="color:${m.change < 0 ? '#b11' : '#1a4'}">${m.change.toFixed(2)}%</span></div>
          <div class="reason">${m.reason||''}</div>
          ${m.news ? `<div class="news"><b>News:</b><br>${m.news.replace(/\n/g,'<br>')}</div>` : ''}
          `;
        elem.appendChild(li);
      });
    }
    function showArchive() {
      let sel = document.getElementById('archiveDropdown');
      let val = sel.value;
      let result = val ? loadArchive(val) : null;
      let archiveDiv = document.getElementById('archiveResults');
      if (!result) { archiveDiv.innerHTML = '<em>No results archived.</em>'; return; }
      let html = '';
      html += `<h4>Likely Mispricings</h4>`;
      if (result.likelyMispricings?.length)
        html += '<ul class="mispricing-list">' + result.likelyMispricings.map(m=>
          `<li class="mispricing"><div class="symbol">${m.symbol} <span style="color:${m.change<0?'#b11':'#1a4'}">${m.change.toFixed(2)}%</span></div><div class="reason">${m.reason||''}</div>${m.news?`<div class="news"><b>News:</b><br>${m.news.replace(/\n/g,'<br>')}</div>`:''}</li>`
        ).join('') + '</ul>';
      else
        html += `<div style="color:#888;">None</div>`;
      html += `<h4>Possible Mispricings</h4>`;
      if (result.possibleMispricings?.length)
        html += '<ul class="mispricing-list">' + result.possibleMispricings.map(m=>
          `<li class="mispricing"><div class="symbol">${m.symbol} <span style="color:${m.change<0?'#b11':'#1a4'}">${m.change.toFixed(2)}%</span></div><div class="reason">${m.reason||''}</div></li>`
        ).join('') + '</ul>';
      else
        html += `<div style="color:#888;">None</div>`;
      archiveDiv.innerHTML = html;
    }

    // === MAIN LOAD ===
    function getNowKey() {
      let d = new Date();
      return roundToNearestHalfHour(new Date(d)).toISOString();
    }
    function showResults(result) {
      const likelyList = document.getElementById('likelyList');
      const possibleList = document.getElementById('possibleList');
      renderMispricings(result.likelyMispricings, likelyList, 'likely');
      renderMispricings(result.possibleMispricings, possibleList, 'possible');
      document.getElementById('noLikely').style.display = result.likelyMispricings.length ? 'none' : '';
      document.getElementById('noPossible').style.display = result.possibleMispricings.length ? 'none' : '';
    }
    function fetchAndRender(force=false) {
      const now = roundToNearestHalfHour(new Date());
      const nowKey = now.toISOString();
      // use cached if available, unless force
      let cached = loadArchive(nowKey);
      if (cached && !force) {
        showResults(cached);
        updateArchiveDropdown();
        return;
      }
      fetch(API_URL)
        .then(r=>r.json())
        .then(result=>{
          showResults(result);
          saveArchive(nowKey, result);
        })
        .catch(err=>{
          alert("Error fetching results. Check your connection.");
        });
    }

    // === SCHEDULING ===
    function msToNextHalfHour() {
      let now = new Date();
      let mins = now.getMinutes();
      let next = new Date(now);
      if (mins < 30) next.setMinutes(30, 0, 0);
      else { next.setHours(next.getHours() + 1); next.setMinutes(0, 0, 0);}
      return next - now;
    }
    function scheduleNextFetch() {
      setTimeout(()=>{
        fetchAndRender(true);
        scheduleNextFetch();
      }, msToNextHalfHour());
    }

    // === COOLDOWN ===
    let cooldownSeconds = 0;
    let cooldownTimer = null;
    function startCooldown() {
      cooldownSeconds = MANUAL_PULL_COOLDOWN;
      updateCooldownDisplay();
      document.getElementById('manualPullBtn').disabled = true;
      cooldownTimer = setInterval(() => {
        cooldownSeconds--;
        updateCooldownDisplay();
        if (cooldownSeconds <= 0) {
          clearInterval(cooldownTimer);
          document.getElementById('manualPullBtn').disabled = false;
          document.getElementById('cooldown').textContent = '';
        }
      }, 1000);
    }
    function updateCooldownDisplay() {
      document.getElementById('cooldown').textContent = cooldownSeconds > 0 ? `(${cooldownSeconds}s)` : '';
    }

    // === EVENT HOOKS ===
    document.getElementById('togglePossible').addEventListener('change', function() {
      document.getElementById('possibleMispricings').style.display = this.checked ? '' : 'none';
    });
    document.getElementById('archiveDropdown').addEventListener('change', showArchive);
    document.getElementById('deleteArchive').addEventListener('click', function() {
      let sel = document.getElementById('archiveDropdown');
      let val = sel.value;
      if (val && confirm("Delete this archive entry?")) {
        localStorage.removeItem(archiveKey(val));
        updateArchiveDropdown();
      }
    });
    document.getElementById('manualPullBtn').addEventListener('click', function() {
      if (cooldownSeconds === 0) {
        fetchAndRender(true);
        startCooldown();
      }
    });

    // === INIT ===
    window.onload = function() {
      fetchAndRender();
      scheduleNextFetch();
      updateArchiveDropdown();
    };
  </script>
</body>
</html>
